<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>LIDAR</title>
  <style>
    canvas { background: #111; }
  </style>
</head>
<body>

<canvas id="lidar" width="1000" height="1000"></canvas>

<script>
const canvas = document.getElementById("lidar");
const ctx = canvas.getContext("2d");
const scale = 0.15; // mm → pixels

const proto = location.protocol === "https:" ? "wss" : "ws";
const ws = new WebSocket(proto + "://" + location.host + "/api/lidar/ws");


ws.onmessage = (e) => {
  const data = JSON.parse(e.data);

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // origine au centre
  ctx.save();
  ctx.translate(canvas.width/2, canvas.height/2);

  // grille simple
  // paramètres d’échelle
  const circleStepMM = 100;   // 10 cm
  const circleCount = 30;     // jusqu’à 3 m

  // grille circulaire
  ctx.strokeStyle = "#333";
  ctx.lineWidth = 1;

  for (let i = 1; i <= circleCount; i++) {
    const r = i * circleStepMM * scale;
    ctx.beginPath();
    ctx.arc(0, 0, r, 0, Math.PI * 2);   
    ctx.stroke();
    if (i % (circleCount / 3) === 0){
    // label distance
    ctx.fillStyle = "#777";
    ctx.font = "10px monospace";
    ctx.fillText(`${i * 10} cm`, r + 2, 0);
    }
  }
  // FOV du lidar (270°)
  ctx.strokeStyle = "#444";
  ctx.lineWidth = 1;

  const fovMin = -135 * Math.PI / 180;
  const fovMax =  135 * Math.PI / 180;
  const fovRadius = circleCount * 100 * scale;

  ctx.beginPath();
  // ligne gauche
  ctx.moveTo(0, 0);
  ctx.lineTo(
  Math.sin(fovMin) * fovRadius,
  -Math.cos(fovMin) * fovRadius
  );
  ctx.stroke();

  // ligne droite
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(
  Math.sin(fovMax) * fovRadius,
  -Math.cos(fovMax) * fovRadius
  );
  ctx.stroke();

  // points lidar
  ctx.fillStyle = "#00ff88";
  for (let i = 0; i < data.x.length; i++) {
    ctx.fillRect(
      data.x[i] * scale,
      -data.y[i] * scale,
      2, 2
    );
  }

  ctx.restore();
};
</script>

</body>
</html>

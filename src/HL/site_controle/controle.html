<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Contrôle Robot Pi</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; background-color: #1a1a1a; color: white; }
        .container { display: flex; gap: 20px; flex-wrap: wrap; }
        .col-main { flex: 2; min-width: 600px; }
        .col-side { flex: 1; min-width: 300px; }

        /* Boites */
        .box {
            background-color: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        h2 { border-bottom: 1px solid #444; padding-bottom: 10px; margin-top: 0; color: #00d2ff; }

        /* Vidéo */
        img#video-stream { width: 100%; border-radius: 5px; background: #000; min-height: 300px; }

        /* Boutons de contrôle */
        .control-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        button {
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #444;
            color: white;
            transition: background 0.3s;
        }
        button:hover { background-color: #666; }
        button:active { transform: scale(0.98); }
        button.stop { background-color: #ff4444; grid-column: span 2; }

        /* Données */
        .data-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 18px; }
        .val { font-weight: bold; color: #00ff88; }

        /* Lidar */
        #lidar-canvas { width: 100%; height: 200px; background: #000; border-radius: 5px; }
    </style>
</head>
<body>

    <h1>Pilotage Robot Raspberry Pi</h1>

    <div class="container">
        <div class="col-main">
            <div class="box">
                <h2>Flux Caméra</h2>
                <img id="video-stream" src="/video_feed" alt="En attente du flux vidéo...">
            </div>

            <div class="box">
                <h2>Scanner Lidar</h2>
                <canvas id="lidar-canvas" width="600" height="200"></canvas>
            </div>
        </div>

        <div class="col-side">

            <div class="box">
                <h2>Programmes</h2>
                <div class="control-grid">
                    <button onclick="envoie_num(1)">Auto Driving</button>
                    <button onclick="envoie_num(2)">PS4 Controller</button>
                    <button onclick="envoie_num(3)">Connect BT</button>
                    <button onclick="envoie_num(4)">Remote Control</button>
                    <button onclick="envoie_num(0)" class="stop">STOP / Idle</button>
                </div>
                <p style="text-align:center; margin-top:10px;">Programme Actuel : <span id="prog-actif" style="color:#00d2ff; font-weight:bold;">--</span></p>
            </div>

            <div class="box">
                <h2>Télémétrie</h2>
                <div class="data-row">LiPo : <span id="val-lipo" class="val">--</span> V</div>
                <div class="data-row">NiMH : <span id="val-nimh" class="val">--</span> V</div>
                <div class="data-row">Vitesse : <span id="val-speed" class="val">--</span></div>
            </div>

            <div id="status" style="color: gray; font-size: 12px; text-align: right;">Connexion...</div>
        </div>
    </div>

<script>
    // --- 1. Changement de Programme ---
    async function envoie_num(num) {
        const statusElem = document.getElementById('status');
        statusElem.textContent = `Envoi commande ${num}...`;

        try {
            // Appel à la route définie : /set_program/<int:prog_id>
            const response = await fetch(`/set_program/${num}`, { method: 'POST' });

            if (response.ok) {
                // On essaie de lire le JSON seulement si le serveur en renvoie un
                try {
                    const result = await response.json();
                    console.log("Retour serveur:", result);
                } catch(e) {
                    console.log("Commande envoyée (pas de JSON reçu)");
                }
                statusElem.textContent = "Commande reçue !";
            } else {
                statusElem.textContent = "Erreur serveur : " + response.status;
            }
        } catch (error) {
            console.error("Erreur commande:", error);
            statusElem.textContent = "Erreur de connexion";
        }
    }

    // --- 2. Récupération des Données (Télémétrie) ---
    async function fetchData() {
        try {
            const response = await fetch('/data');
            if (!response.ok) throw new Error("Erreur réseau");

            const data = await response.json();

            // --- Adaptation aux clés du dictionnaire Python ---
            // Python structure:
            // { "batterie": {"lipo": X, "nimh": Y}, "robot": {"vitesse": Z, "programme": P, "lidar": L} }

            if (data.batterie) {
                document.getElementById('val-lipo').textContent = (data.batterie.lipo || 0).toFixed(2);
                document.getElementById('val-nimh').textContent = (data.batterie.nimh || 0).toFixed(2);
            }

            if (data.robot) {
                document.getElementById('val-speed').textContent = (data.robot.vitesse || 0).toFixed(2);
                document.getElementById('prog-actif').textContent = data.robot.programme || "Inconnu";

                // Dessin du Lidar si les données existent
                if (Array.isArray(data.robot.lidar)) {
                    drawLidar(data.robot.lidar);
                }
            }

            document.getElementById('status').textContent = "Connecté - " + new Date().toLocaleTimeString();

        } catch (error) {
            console.error("Erreur fetch:", error);
            document.getElementById('status').textContent = "Déconnecté"; // Indicateur visuel important
        }
    }

    // --- 3. Visualisation Lidar (Simple) ---
    function drawLidar(distances) {
        const canvas = document.getElementById('lidar-canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;

        // Reset fond noir
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, width, height);

        if (distances.length === 0) return;

        ctx.strokeStyle = '#00ff00';
        ctx.lineWidth = 2;
        ctx.beginPath();

        const step = width / distances.length;

        distances.forEach((dist, i) => {
            // Echelle : supposons que 2000mm = haut du canvas
            let barHeight = (dist / 2000) * height;
            if (barHeight > height) barHeight = height;

            // On dessine "l'espace vide" ou l'obstacle
            // Ici on dessine une ligne au sol qui monte selon la distance
            const x = i * step;
            const y = height - barHeight;

            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });
        ctx.stroke();
    }

    // Rafraichissement toutes les 500ms
    setInterval(fetchData, 500);
    // Premier appel immédiat
    fetchData();

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Contrôle Robot Pi</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; background-color: #1a1a1a; color: white; }

        .container { display: flex; gap: 20px; flex-wrap: wrap; }
        .col-main { flex: 2; min-width: 600px; }
        .col-side { flex: 1; min-width: 300px; }

        /* Boites */
        .box {
            background-color: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        h2 { border-bottom: 1px solid #444; padding-bottom: 10px; margin-top: 0; color: #00d2ff; }

        /* Vidéo */
        img#video-stream { width: 100%; border-radius: 5px; background: #000; }

        /* Boutons de contrôle */
        .control-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        button {
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #444;
            color: white;
            transition: background 0.3s;
        }
        button:hover { background-color: #666; }
        button.active { background-color: #00d2ff; color: #000; font-weight: bold; }
        button.stop { background-color: #ff4444; grid-column: span 2; }

        /* Données */
        .data-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 18px; }
        .val { font-weight: bold; color: #00ff88; }

        /* Lidar Simple Visualisation */
        #lidar-canvas { width: 100%; height: 200px; background: #000; border-radius: 5px; }
    </style>
</head>
<body>

    <h1>Pilotage Robot Raspberry Pi</h1>

    <div class="container">
        <div class="col-main">
            <div class="box">
                <h2>Flux Caméra</h2>
                <img id="video-stream" src="/video_feed" alt="Flux Vidéo non disponible">
            </div>

            <div class="box">
                <h2>Scanner Lidar</h2>
                <canvas id="lidar-canvas" width="600" height="200"></canvas>
            </div>
        </div>

        <div class="col-side">

            <div class="box">
                <h2>Programmes</h2>
                <div class="control-grid">
                    <button onclick="envoie_num(1)">Auto Driving</button>
                    <button onclick="envoie_num(2)">PS4 Controller</button>
                    <button onclick="envoie_num(3)">Connect BT</button>
                    <button onclick="envoie_num(4)">Remote Control</button>
                    <button onclick="envoie_num(0)" class="stop">STOP / Idle</button>
                </div>
                <p style="text-align:center; margin-top:10px;">Actif : <span id="prog-actif" style="color:#00d2ff">--</span></p>
            </div>

            <div class="box">
                <h2>Télémétrie</h2>
                <div class="data-row">LiPo : <span id="val-lipo" class="val">--</span> V</div>
                <div class="data-row">NiMH : <span id="val-nimh" class="val">--</span> V</div>
                <div class="data-row">Vitesse : <span id="val-speed" class="val">--</span></div>
            </div>

            <div id="status" style="color: gray; font-size: 12px;">Connexion...</div>
        </div>
    </div>

<script>
    // Pas besoin de mettre l'IP en dur si on sert le fichier depuis Flask (chemin relatif)
    // Si vous ouvrez le fichier HTML en local (file://), remettez http://IP_DU_PI:5000
    const API_BASE = "";

    // --- Fonction demandée pour changer de programme ---
    async function envoie_num(num) {
        try {
            const response = await fetch(`${API_BASE}/set_program/${num}`, { method: 'POST' });
            const result = await response.json();
            console.log("Changement programme:", result);

            // Mise à jour visuelle rapide (sera confirmée par le fetchData)
            document.getElementById('status').textContent = `Commande programme ${num} envoyée...`;
        } catch (error) {
            console.error("Erreur commande:", error);
            alert("Impossible de changer le programme");
        }
    }

    // --- Récupération des données ---
    async function fetchData() {
        try {
            const response = await fetch(`${API_BASE}/data`);
            if (!response.ok) throw new Error("Erreur réseau");

            const data = await response.json();

            // Mise à jour Texte
            document.getElementById('val-lipo').textContent = data.batterie.lipo.toFixed(2);
            document.getElementById('val-nimh').textContent = data.batterie.nimh.toFixed(2);
            document.getElementById('val-speed').textContent = data.robot.vitesse.toFixed(2);
            document.getElementById('prog-actif').textContent = data.robot.programme;
            document.getElementById('status').textContent = "Connecté - " + new Date().toLocaleTimeString();

            // Mise à jour Canvas Lidar (Visualisation simple des distances)
            if (data.robot.lidar) {
                drawLidar(data.robot.lidar);
            }

        } catch (error) {
            console.error(error);
            document.getElementById('status').textContent = "Déconnecté";
        }
    }

    // --- Dessin simple du Lidar ---
    function drawLidar(distances) {
        const canvas = document.getElementById('lidar-canvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;

        // Effacer
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, width, height);
        ctx.strokeStyle = '#00ff00';
        ctx.beginPath();

        // On trace une ligne représentant les distances
        const step = width / distances.length;

        distances.forEach((dist, i) => {
            // Normalisation simple (0-2000mm vers 0-height)
            let h = (dist / 2000) * height;
            if (h > height) h = height;

            ctx.moveTo(i * step, height);
            ctx.lineTo(i * step, height - h);
        });
        ctx.stroke();
    }

    // Boucle de mise à jour (toutes les 500ms)
    setInterval(fetchData, 500);
    fetchData();

</script>
</body>
</html>